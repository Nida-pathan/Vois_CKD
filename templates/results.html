{% extends "base.html" %}

{% block content %}
<style>
    .patient-details-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .header h1 {
        color: #0f766e;
        font-weight: 700;
        margin: 0;
    }

    .back-btn {
        background: #0d9488;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .back-btn:hover {
        background: #0f766e;
        transform: translateY(-2px);
    }

    .section {
        background: white;
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title i {
        color: #0d9488;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .info-item {
        padding: 15px;
        background: #f9fafb;
        border-radius: 8px;
    }

    .info-label {
        font-size: 0.9rem;
        color: #6b7280;
        margin-bottom: 5px;
    }

    .info-value {
        font-weight: 600;
        color: #111827;
        font-size: 1.1rem;
    }

    .lab-results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .lab-card {
        background: #f9fafb;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
    }

    .lab-card-title {
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }

    .lab-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .lab-item:last-child {
        border-bottom: none;
    }

    .lab-label {
        color: #666;
    }

    .lab-value {
        font-weight: 600;
    }

    .risk-card {
        text-align: center;
        padding: 30px;
    }

    .risk-percentage-large {
        font-size: 48px;
        font-weight: 700;
        margin: 20px 0;
    }

    .risk-level-badge {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .risk-bar {
        height: 12px;
        background: #e5e7eb;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .risk-fill {
        height: 100%;
        border-radius: 6px;
    }

    .stage-display {
        text-align: center;
        padding: 20px;
    }

    .stage-number {
        font-size: 48px;
        font-weight: 700;
        margin: 20px 0;
        color: #0d9488;
    }

    .stage-description {
        font-size: 14px;
        color: #666;
        margin-bottom: 20px;
    }

    .egfr-display {
        font-size: 18px;
        font-weight: 600;
    }

    .prescription-item {
        padding: 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 15px;
        background: #f9fafb;
    }

    .prescription-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e5e7eb;
    }

    .prescription-date {
        font-weight: 600;
        color: #0d9488;
    }

    .medication-item {
        padding: 10px;
        background: rgba(13, 148, 136, 0.05);
        border-radius: 8px;
        margin-bottom: 10px;
    }

    .medication-name {
        font-weight: 600;
        color: #0d9488;
    }

    .medication-details {
        font-size: 0.9rem;
        color: #666;
        margin-top: 5px;
    }

    .lab-result-item {
        padding: 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 15px;
        background: #f9fafb;
    }

    .lab-result-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e5e7eb;
    }

    .lab-result-date {
        font-weight: 600;
        color: #0d9488;
    }

    .upload-section {
        text-align: center;
        padding: 30px;
        background: #f0fdfa;
        border-radius: 16px;
        border: 2px dashed #0d9488;
    }

    .btn-upload {
        background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 30px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-top: 15px;
    }

    .btn-upload:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
    }
</style>

<div class="patient-details-container">
    <div class="header">
        <h1>Patient Details</h1>
        {% if current_user.is_doctor() %}
        <a href="{{ url_for('doctor_dashboard') }}" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        {% else %}
        <a href="{{ url_for('patient_portal') }}" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Portal
        </a>
        {% endif %}
    </div>

    {% if patient %}
    <!-- Patient Information -->
    <div class="section">
        <div class="section-title">
            <i class="fas fa-user"></i> Patient Information
        </div>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Patient ID</div>
                <div class="info-value">{{ patient.patient_id }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Full Name</div>
                <div class="info-value">{{ patient.patient_name if patient.patient_name else patient.name }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Age</div>
                <div class="info-value">{{ patient.age if patient.age else 'N/A' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Gender</div>
                <div class="info-value">{{ patient.gender if patient.gender else 'N/A' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Blood Type</div>
                <div class="info-value">{{ patient.blood_type if patient.blood_type else 'N/A' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Phone</div>
                <div class="info-value">{{ patient.phone if patient.phone else 'N/A' }}</div>
            </div>
        </div>
    </div>



    <!-- Disease Status Grid -->
    <div class="section">
        <div class="section-title">
            <i class="fas fa-heartbeat"></i> Disease Status
        </div>
        <div class="disease-status-grid"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <!-- CKD Card -->
            <div class="disease-status-card"
                style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; text-align: center;">
                <div class="disease-icon" style="color: #0d9488; font-size: 24px; margin-bottom: 10px;"><i
                        class="fas fa-kidney"></i></div>
                <h4 style="margin: 0 0 10px 0; color: #374151;">CKD</h4>
                <div class="disease-value" style="font-size: 18px; font-weight: 600; color: #111827;">
                    Stage {{ patient.stage if patient.stage else 'N/A' }}
                </div>
                <div class="disease-sub" style="font-size: 13px; color: #6b7280; margin-top: 5px;">
                    eGFR: {{ "%.1f"|format(patient.egfr|float) if patient.egfr and patient.egfr|float > 0 else 'N/A' }}
                </div>
            </div>

            <!-- Kidney Stone Card -->
            <div class="disease-status-card"
                style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; text-align: center;">
                <div class="disease-icon" style="color: #f5576c; font-size: 24px; margin-bottom: 10px;"><i
                        class="fas fa-gem"></i></div>
                <h4 style="margin: 0 0 10px 0; color: #374151;">Kidney Stone</h4>
                <div class="disease-value" style="font-size: 18px; font-weight: 600; color: #111827;">
                    {{ patient.kidney_stone_risk if patient.kidney_stone_risk else 'N/A' }}
                </div>
                <div class="disease-sub" style="font-size: 13px; color: #6b7280; margin-top: 5px;">
                    Risk Analysis
                </div>
            </div>

            <!-- AKI Card -->
            <div class="disease-status-card"
                style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; text-align: center;">
                <div class="disease-icon" style="color: #fa709a; font-size: 24px; margin-bottom: 10px;"><i
                        class="fas fa-exclamation-triangle"></i></div>
                <h4 style="margin: 0 0 10px 0; color: #374151;">AKI</h4>
                <div class="disease-value" style="font-size: 18px; font-weight: 600; color: #111827;">
                    {{ patient.aki_risk if patient.aki_risk else 'N/A' }}
                </div>
                <div class="disease-sub" style="font-size: 13px; color: #6b7280; margin-top: 5px;">
                    Risk Level
                </div>
            </div>

            <!-- ESRD Card -->
            <div class="disease-status-card"
                style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; text-align: center;">
                <div class="disease-icon" style="color: #30cfd0; font-size: 24px; margin-bottom: 10px;"><i
                        class="fas fa-heartbeat"></i></div>
                <h4 style="margin: 0 0 10px 0; color: #374151;">ESRD</h4>
                <div class="disease-value" style="font-size: 18px; font-weight: 600; color: #111827;">
                    {{ patient.esrd_status if patient.esrd_status else 'N/A' }}
                </div>
                <div class="disease-sub" style="font-size: 13px; color: #6b7280; margin-top: 5px;">
                    Status
                </div>
            </div>
        </div>
    </div>

    <!-- Lab Results -->
    <div class="section">
        <div class="section-title">
            <i class="fas fa-vial"></i> Lab Results
        </div>
        <div class="lab-results-grid">
            <div class="lab-card">
                <div class="lab-card-title">Kidney Function</div>
                <div class="lab-item">
                    <span class="lab-label">Serum Creatinine</span>
                    <span class="lab-value">{{ patient.serum_creatinine if patient.serum_creatinine else 'N/A' }}
                        mg/dL</span>
                </div>
                <div class="lab-item">
                    <span class="lab-label">Blood Urea Nitrogen</span>
                    <span class="lab-value">{{ patient.blood_urea if patient.blood_urea else 'N/A' }}
                        mg/dL</span>
                </div>
                <div class="lab-item">
                    <span class="lab-label">eGFR</span>
                    <span class="lab-value">{{ "%.1f"|format(patient.egfr|float) if patient.egfr and patient.egfr|float
                        > 0 else 'N/A' }}
                        mL/min/1.73mÂ²</span>
                </div>
            </div>
            <div class="lab-card">
                <div class="lab-card-title">Blood Metrics</div>
                <div class="lab-item">
                    <span class="lab-label">Hemoglobin</span>
                    <span class="lab-value">{{ patient.hemoglobin if patient.hemoglobin else 'N/A' }}
                        g/dL</span>
                </div>
                <div class="lab-item">
                    <span class="lab-label">Sodium</span>
                    <span class="lab-value">{{ patient.sodium if patient.sodium else 'N/A' }} mEq/L</span>
                </div>
                <div class="lab-item">
                    <span class="lab-label">Potassium</span>
                    <span class="lab-value">{{ patient.potassium if patient.potassium else 'N/A' }} mEq/L</span>
                </div>
            </div>
            <div class="lab-card">
                <div class="lab-card-title">Other Metrics</div>
                <div class="lab-item">
                    <span class="lab-label">Blood Glucose</span>
                    <span class="lab-value">{{ patient.blood_glucose if patient.blood_glucose else 'N/A' }}
                        mg/dL</span>
                </div>
                <div class="lab-item">
                    <span class="lab-label">Blood Pressure</span>
                    <span class="lab-value">{{ patient.bp_systolic if patient.bp_systolic else 'N/A' }}/{{
                        patient.bp_diastolic if patient.bp_diastolic else 'N/A' }} mmHg</span>
                </div>
                <div class="lab-item">
                    <span class="lab-label">Albumin</span>
                    <span class="lab-value">{{ patient.albumin if patient.albumin else 'N/A' }} g/dL</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Latest AI Analysis Report -->
    {% if patient.latest_ai_report %}
    <div class="section">
        <div class="section-title">
            <i class="fas fa-robot"></i> Latest AI Analysis Report
        </div>
        <div
            style="display: flex; align-items: center; justify-content: space-between; background: #f0fdfa; padding: 20px; border-radius: 12px; border: 1px solid #ccfbf1;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div
                    style="width: 50px; height: 50px; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <i class="fas fa-file-pdf" style="font-size: 24px; color: #0d9488;"></i>
                </div>
                <div>
                    <h4 style="margin: 0 0 5px 0; color: #0f766e;">AI Analysis & Recommendations</h4>
                    <p style="margin: 0; font-size: 13px; color: #5f6c7b;">Generated on {{ patient.latest_ai_report.date
                        }}</p>
                </div>
            </div>
            <a href="{{ url_for('static', filename=patient.latest_ai_report.pdf_path) }}" target="_blank"
                class="btn-upload" style="margin-top: 0; text-decoration: none;">
                <i class="fas fa-download"></i> View Report
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Latest Lab Report -->
    {% if patient.latest_lab_report %}
    <div class="section">
        <div class="section-title">
            <i class="fas fa-vial"></i> Latest Lab Report
        </div>
        <div
            style="display: flex; align-items: center; justify-content: space-between; background: #f0fdfa; padding: 20px; border-radius: 12px; border: 1px solid #ccfbf1;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div
                    style="width: 50px; height: 50px; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <i class="fas fa-file-pdf" style="font-size: 24px; color: #ef4444;"></i>
                </div>
                <div>
                    <h4 style="margin: 0 0 5px 0; color: #0f766e;">Lab Report PDF</h4>
                    <p style="margin: 0; font-size: 13px; color: #5f6c7b;">Uploaded on {{ patient.latest_lab_report.date
                        }}</p>
                </div>
            </div>
            <a href="{{ url_for('static', filename=patient.latest_lab_report.pdf_path) }}" target="_blank"
                class="btn-upload" style="margin-top: 0; text-decoration: none;">
                <i class="fas fa-download"></i> View Report
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Historical Lab Results -->
    {% if lab_results and lab_results|length > 0 %}
    <div class="section">
        <div class="section-title">
            <i class="fas fa-history"></i> Historical Lab Results
        </div>
        {% for result in lab_results|reverse %}
        <div class="lab-result-item {% if loop.index > 2 %}hidden-lab-result{% endif %}" {% if loop.index> 2
            %}style="display: none;"{% endif %}>
            <div class="lab-result-header">
                <div class="lab-result-date">{{ result.test_date }}</div>
                <div>{{ result.test_type }}</div>
            </div>
            <div class="lab-results-grid">
                {% if result.results %}
                {% for key, value in result.results.items() %}
                <div class="lab-item">
                    <span class="lab-label">{{ key }}</span>
                    <span class="lab-value">{{ value }}</span>
                </div>
                {% endfor %}
                {% else %}
                <!-- Handle flat structure by iterating and excluding metadata -->
                {% for key, value in result.items() %}
                {% if key not in ['_id', 'patient_id', 'patient_username', 'test_date', 'test_type', 'notes',
                'created_at', 'pdf_path'] %}
                <div class="lab-item" style="display: block;">
                    <span class="lab-label" style="display: block; margin-bottom: 5px;">{{ key|replace('_', ' ')|title
                        }}</span>
                    <span class="lab-value">
                        {% if value is mapping %}
                        <div style="background: rgba(0,0,0,0.02); padding: 10px; border-radius: 6px; font-size: 0.9em;">
                            {% for k, v in value.items() %}
                            {% if k != 'image_path' and k != 'recommendations' %}
                            <div style="margin-bottom: 4px;">
                                <span style="font-weight: 600; color: #555;">{{ k|replace('_', ' ')|title }}:</span>
                                <span>{{ v }}</span>
                            </div>
                            {% endif %}
                            {% endfor %}

                            {% if 'recommendations' in value %}
                            <div style="margin-top: 8px;">
                                <span style="font-weight: 600; color: #555;">Recommendations:</span>
                                <ul style="margin: 5px 0 0 0; padding-left: 20px;">
                                    {% for rec in value['recommendations'] %}
                                    <li>{{ rec }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        {{ value }}
                        {% endif %}
                    </span>
                </div>
                {% endif %}
                {% endfor %}
                {% endif %}
            </div>
            {% if result.notes %}
            <div style="margin-top: 10px; padding: 10px; background: #fffbeb; border-radius: 8px;">
                <strong>Notes:</strong> {{ result.notes }}
            </div>
            {% endif %}
        </div>
        {% endfor %}

        {% if lab_results|length > 2 %}
        <div style="text-align: center; margin-top: 15px;">
            <button id="toggleLabBtn" onclick="toggleLabHistory()" class="btn-upload"
                style="background: white; color: #0d9488; border: 1px solid #0d9488; font-size: 14px; padding: 8px 20px;">
                View More
            </button>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Medical History & Documents -->
    {% if patient.history and patient.history|length > 0 %}
    <div class="section">
        <div class="section-title">
            <i class="fas fa-folder-open"></i> Document History
        </div>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f9fafb; text-align: left;">
                        <th style="padding: 12px; border-bottom: 2px solid #e5e7eb; color: #4b5563;">Date</th>
                        <th style="padding: 12px; border-bottom: 2px solid #e5e7eb; color: #4b5563;">Type</th>
                        <th style="padding: 12px; border-bottom: 2px solid #e5e7eb; color: #4b5563;">Prediction
                        </th>
                        <th style="padding: 12px; border-bottom: 2px solid #e5e7eb; color: #4b5563;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in patient.history|reverse %}
                    <tr class="{% if loop.index > 2 %}hidden-doc-history{% endif %}" {% if loop.index> 2
                        %}style="display: none;"{% endif %} style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px; color: #333;">{{ record.date if record.date else 'Unknown
                            Date' }}
                        </td>
                        <td style="padding: 12px; color: #666;">{{ record.test_type if record.test_type else 'Lab Report
                            Analysis' }}</td>
                        <td style="padding: 12px;">
                            {% if record.prediction %}
                            <span
                                class="badge badge-{{ record.prediction.risk_level.lower() if record.prediction.risk_level else 'moderate' }}">
                                {{ record.prediction.disease if record.prediction.disease else 'CKD' }} - {{
                                record.prediction.risk_level if record.prediction.risk_level else 'Unknown' }}
                            </span>
                            {% else %}
                            <span style="color: #9ca3af;">N/A</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px;">
                            {% if record.pdf_path %}
                            <a href="{{ url_for('static', filename=record.pdf_path) }}" target="_blank"
                                style="color: #0d9488; text-decoration: none; font-weight: 500;">
                                <i class="fas fa-file-pdf"></i> View PDF
                            </a>
                            {% else %}
                            <span style="color: #9ca3af; font-size: 13px;">No File</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% if patient.history and patient.history|length > 2 %}
    <div style="text-align: center; margin-top: 15px;">
        <button id="toggleDocBtn" onclick="toggleDocHistory()" class="btn-upload"
            style="background: white; color: #0d9488; border: 1px solid #0d9488; font-size: 14px; padding: 8px 20px;">
            View More
        </button>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Prescriptions -->
<div class="section">
    <div class="section-title">
        <i class="fas fa-prescription"></i> Medications & Prescriptions
    </div>
    {% if prescriptions and prescriptions|length > 0 %}
    {% for prescription in prescriptions %}
    <div class="prescription-item">
        <div class="prescription-header">
            <div class="prescription-date">{{ prescription.date }}</div>
            <div>Prescribed by: Dr. {{ prescription.doctor }}</div>
        </div>
        <div style="margin-bottom: 15px;">
            <strong>Medications:</strong>
            {% for med in prescription.medications %}
            <div class="medication-item">
                <div class="medication-name">{{ med.name }}</div>
                <div class="medication-details">
                    Dosage: {{ med.dosage }} | Frequency: {{ med.frequency }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% if prescription.notes %}
        <div style="padding: 10px; background: #fffbeb; border-radius: 8px;">
            <strong>Notes:</strong> {{ prescription.notes }}
        </div>
        {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <p><strong>NOTE : Previously prescriped medication included</strong></p>
    {% endif %}

    <!-- Prescription Upload Button -->
    <div class="upload-section">
        <h3><i class="fas fa-file-upload"></i> Upload New Prescription</h3>
        <p>Upload a new prescription for this patient</p>
        <button class="btn-upload"
            onclick="window.location.href=&quot;{{ url_for('prescriptions', patient=patient.username if patient.username else patient.name) }}&quot;">
            <i class="fas fa-plus"></i> Create New Prescription
        </button>
    </div>
</div>

{% else %}
<div class="section">
    <div style="text-align: center; padding: 60px 20px;">
        <i class="fas fa-user-times" style="font-size: 48px; margin-bottom: 20px; color: #ef4444;"></i>
        <h3>Patient Not Found</h3>
        <p>The requested patient information could not be found.</p>
        {% if current_user.is_doctor() %}
        <a href="{{ url_for('doctor_dashboard') }}" class="back-btn" style="display: inline-flex; margin-top: 20px;">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        {% else %}
        <a href="{{ url_for('patient_portal') }}" class="back-btn" style="display: inline-flex; margin-top: 20px;">
            <i class="fas fa-arrow-left"></i> Back to Portal
        </a>
        {% endif %}
    </div>
</div>
{% endif %}
</div>

<script>
    function toggleLabHistory() {
        const hiddenItems = document.querySelectorAll('.hidden-lab-result');
        const btn = document.getElementById('toggleLabBtn');
        let isHidden = false;

        hiddenItems.forEach(item => {
            if (item.style.display === 'none') {
                item.style.display = 'block';
                isHidden = true; // Was hidden, now shown
            } else {
                item.style.display = 'none';
                isHidden = false; // Was shown, now hidden
            }
        });

        // If we just showed them (was hidden is true for at least one iteration where we switched), 
        // OR better logic: check current state of first item
        const firstHidden = document.querySelector('.hidden-lab-result');
        if (firstHidden && firstHidden.style.display !== 'none') {
            btn.textContent = 'View Less';
        } else {
            btn.textContent = 'View More';
        }
    }

    function toggleDocHistory() {
        const hiddenRows = document.querySelectorAll('.hidden-doc-history');
        const btn = document.getElementById('toggleDocBtn');

        hiddenRows.forEach(row => {
            const originalDisplay = row.tagName === 'TR' ? 'table-row' : 'block';
            if (row.style.display === 'none') {
                row.style.display = originalDisplay;
            } else {
                row.style.display = 'none';
            }
        });

        const firstHidden = document.querySelector('.hidden-doc-history');
        if (firstHidden && firstHidden.style.display !== 'none') {
            btn.textContent = 'View Less';
        } else {
            btn.textContent = 'View More';
        }
    }
</script>
{% endblock %}