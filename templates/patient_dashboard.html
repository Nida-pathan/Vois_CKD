<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard - CKD Companion</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            --risk-high-gradient: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --risk-moderate-gradient: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --risk-low-gradient: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.18);
            --text-primary: #333333;
            --text-secondary: #666666;
            --shadow-light: 0 4px 30px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 8px 32px rgba(0, 0, 0, 0.1);
            --border-radius-sm: 8px;
            --border-radius-md: 16px;
            --border-radius-lg: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #f0fdfa 0%, #e0f2fe 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Top Welcome Section */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            padding: 20px 30px;
            box-shadow: var(--shadow-light);
        }

        .welcome-message h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .welcome-message p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .search-bar {
            position: relative;
        }

        .search-bar input {
            padding: 10px 15px 10px 40px;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius-sm);
            background: white;
            width: 250px;
            font-size: 14px;
        }

        .search-bar i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(220, 38, 38, 0.1);
            color: #dc2626;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(220, 38, 38, 0.2);
            transform: translateY(-1px);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            padding: 20px;
            box-shadow: var(--shadow-light);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .stat-card.stage-1 {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .stat-card.stage-2 {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .stat-card.stage-3 {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
        }

        .stat-card.stage-4 {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
        }

        .stat-card.stage-5 {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        /* Patient Education Chatbot Styles */
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 99999;
        }

        .chatbot-toggle {
            z-index: 99999;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
            transition: all 0.3s ease;
            color: white;
            font-size: 24px;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(139, 92, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0);
            }
        }

        .chatbot-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.6);
        }

        .chatbot-window {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 350px;
            height: 400px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chatbot-container.active .chatbot-window {
            display: flex;
        }

        .chatbot-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .chatbot-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chatbot-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .chatbot-message.user {
            align-self: flex-end;
            background: #8b5cf6;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chatbot-message.bot {
            align-self: flex-start;
            background: #f1f5f9;
            color: #1e293b;
            border-bottom-left-radius: 4px;
        }

        .chatbot-input-container {
            display: flex;
            padding: 15px;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .chatbot-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #cbd5e1;
            border-radius: 24px;
            font-size: 0.9rem;
            outline: none;
        }

        .chatbot-input:focus {
            border-color: #8b5cf6;
        }

        .chatbot-send {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 10px 20px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chatbot-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        /* Dark mode support for chatbot */
        [data-theme='dark'] .chatbot-window {
            background: #1e293b;
            color: #f1f5f9;
        }

        [data-theme='dark'] .chatbot-message.bot {
            background: #334155;
            color: #f1f5f9;
        }

        [data-theme='dark'] .chatbot-input {
            background: #0f172a;
            border-color: #334155;
            color: #f1f5f9;
        }

        [data-theme='dark'] .chatbot-input-container {
            border-top-color: #334155;
            background: #1e293b;
        }

        /* Responsive styles for chatbot */
        @media (max-width: 768px) {
            .chatbot-window {
                width: 300px;
                height: 350px;
            }
        }

        @media (max-width: 480px) {
            .chatbot-container {
                bottom: 10px;
                right: 10px;
            }

            .chatbot-window {
                width: 280px;
                height: 300px;
                bottom: 60px;
            }
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
        }

        /* Main Content Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        /* Card Styles */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            padding: 25px;
            box-shadow: var(--shadow-light);
            margin-bottom: 25px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-action {
            color: #0d9488;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .card-action:hover {
            text-decoration: underline;
        }

        /* Free Trial Section */
        .trial-section {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            color: white;
            border-radius: var(--border-radius-md);
            padding: 25px;
            margin-bottom: 25px;
        }

        .trial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .trial-title {
            font-size: 20px;
            font-weight: 600;
        }

        .trial-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius-sm);
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Doctors List */
        .doctor-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.3s ease;
        }

        .doctor-item:hover {
            background-color: #f9fafb;
        }

        .doctor-item:last-child {
            border-bottom: none;
        }

        .doctor-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 15px;
        }

        .doctor-info {
            flex: 1;
        }

        .doctor-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .doctor-specialty {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .doctor-experience {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .book-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .book-btn:hover {
            transform: scale(1.05);
        }

        /* Health Metrics */
        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .metric-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .status-normal {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-warning {
            background: #fef3c7;
            color: #d97706;
        }

        .status-critical {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Lab Results */
        .lab-result-item {
            background: #f9fafb;
            border-radius: var(--border-radius-sm);
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #0d9488;
        }

        .lab-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .lab-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .lab-metrics {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .lab-metric {
            font-size: 12px;
        }

        .lab-metric-label {
            color: var(--text-secondary);
        }

        .lab-metric-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Therapy Cards */
        .therapy-card {
            background: linear-gradient(135deg, #f0fdfa 0%, #e0f2fe 100%);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e5e7eb;
        }

        .therapy-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .therapy-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .therapy-duration {
            font-size: 11px;
            color: #0d9488;
            font-weight: 500;
        }

        /* Diet & Lifestyle */
        .lifestyle-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .lifestyle-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .lifestyle-content {
            flex: 1;
        }

        .lifestyle-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
            font-size: 14px;
        }

        .lifestyle-description {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .top-bar {
                flex-direction: column;
                gap: 15px;
            }

            .top-bar-right {
                width: 100%;
                justify-content: space-between;
            }

            .search-bar input {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Upcoming Appointments */
        .upcoming-appointment-item {
            background: linear-gradient(135deg, #f0fdfa 0%, #e0f2fe 100%);
            border-radius: var(--border-radius-sm);
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #0d9488;
        }

        .upcoming-appointment-item:last-child {
            margin-bottom: 0;
        }

        .appointment-doctor {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .appointment-info {
            flex: 1;
        }

        .appointment-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .appointment-datetime {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .join-meeting-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 10px 20px;
            border-radius: var(--border-radius-sm);
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .join-meeting-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        @media (max-width: 768px) {
            .appointment-details {
                flex-direction: column;
                align-items: stretch;
            }

            .join-meeting-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Top Welcome Section -->
        <div class="top-bar">
            <div class="welcome-message">
                <h1>Welcome back, {{ current_user.username }}!</h1>
                <p>Your kidney health companion dashboard</p>
                <!-- Manual tour trigger for debugging -->
                <button id="start-tour-btn"
                    style="margin-top: 10px; padding: 5px 10px; background: #0d9488; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;"
                    onclick="startTourManually()">Start Tour</button>
            </div>
            <div class="top-bar-right">
                <div class="user-menu">
                    <div class="user-avatar">{{ current_user.username[0].upper() }}</div>
                    <a href="{{ url_for('logout') }}" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid" id="stats-overview">
            <div class="stat-card {{ patient_data.stage_class }}">
                <div class="stat-icon"><i class="fas fa-kidney"></i></div>
                <div class="stat-label">CKD Stage</div>
                <div class="stat-number">{{ patient_data.ckd_stage }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-heart"></i></div>
                <div class="stat-label">Risk Level</div>
                <div class="stat-number">{{ patient_data.risk_level }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-label">Next Checkup</div>
                <div class="stat-number">
                    {% if upcoming_appointments %}
                    {{ upcoming_appointments[0].preferred_date }}
                    {% else %}
                    Not scheduled
                    {% endif %}
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-file-medical"></i></div>
                <div class="stat-label">Lab Reports</div>
                <div class="stat-number">{{ patient_data.lab_reports_count }}</div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Left Column -->
            <div class="main-content">
                <!-- Free Trial Lab Upload Section -->
                <div class="trial-section" id="upload-section">
                    <div class="trial-header">
                        <div class="trial-title">
                            <i class="fas fa-flask"></i> Lab Report Analysis
                        </div>
                    </div>
                    <div class="upload-area" onclick="window.location.href='{{ url_for('lab_analysis') }}'"
                        style="cursor: pointer;">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">Upload your lab reports for AI analysis</div>
                        <div class="upload-subtext">Supports PDF format • Select Disease Type</div>
                    </div>
                </div>

                <!-- Patient Information -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-user"></i> Patient Information
                        </div>
                        <a href="#" class="card-action">Edit</a>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Full Name</span>
                        <span class="metric-value">{{ current_user.username }}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Age</span>
                        <span class="metric-value">{{ patient_data.age }}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Blood Type</span>
                        <span class="metric-value">{{ patient_data.blood_type }}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Patient ID</span>
                        <span class="metric-value">{{ patient_data.patient_id }}</span>
                    </div>
                </div>

                <!-- Therapy Recommendations -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-prescription-bottle"></i> Therapy Recommendations
                        </div>
                        <a href="{{ url_for('therapy_plan') }}" class="card-action">View Plan</a>
                    </div>
                    <div style="padding: 15px 0; border-top: 1px solid #e5e7eb; margin-top: 10px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div
                                style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-heartbeat" style="color: white; font-size: 18px;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">
                                    Personalized Care Plan</div>
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                                    Your tailored therapy recommendations are designed to help manage your kidney health
                                    and improve your quality of life. Follow these evidence-based interventions for
                                    optimal results.
                                </div>
                            </div>
                        </div>
                        <div
                            style="background: linear-gradient(135deg, #f0fdfa 0%, #e0f2fe 100%); border-radius: 8px; padding: 12px 15px; border-left: 4px solid #0d9488;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                <i class="fas fa-check-circle" style="color: #0d9488; font-size: 16px;"></i>
                                <span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">Key
                                    Benefits:</span>
                            </div>
                            <ul
                                style="margin: 0; padding-left: 24px; font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                <li>Slow disease progression</li>
                                <li>Manage symptoms effectively</li>
                                <li>Improve overall well-being</li>
                                <li>Reduce risk of complications</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Latest AI Analysis Report -->
                {% if patient_data.latest_ai_report %}
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-robot"></i> Latest AI Analysis Report
                        </div>
                    </div>
                    <div class="metric-item">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">
                                {{ patient_data.latest_ai_report.date }}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">
                                Prescription Analysis
                            </div>
                        </div>
                        <a href="{{ url_for('static', filename=patient_data.latest_ai_report.pdf_path) }}"
                            target="_blank" class="card-action">
                            <i class="fas fa-file-pdf"></i> View Report
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Latest Lab Report -->
                {% if patient_data.latest_lab_report %}
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-vial"></i> Latest Lab Report
                        </div>
                    </div>
                    <div class="metric-item">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">
                                {{ patient_data.latest_lab_report.date }}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">
                                {{ patient_data.latest_lab_report.test_type if patient_data.latest_lab_report.test_type
                                else 'Lab Analysis' }}
                            </div>
                        </div>
                        <a href="{{ url_for('static', filename=patient_data.latest_lab_report.pdf_path) }}"
                            target="_blank" class="card-action">
                            <i class="fas fa-file-pdf"></i> View Report
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Report History -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-history"></i> Report History
                        </div>
                    </div>

                    {% if patient_data.history %}
                    {% set history_list = patient_data.history | reverse | list %}

                    {# Show first 3 items #}
                    {% for report in history_list[:3] %}
                    <div class="metric-item">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">{{ report.date }} - {{
                                report.test_type if report.test_type else 'Lab Analysis' }}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                {% if report.metrics.egfr %}eGFR: {{ report.metrics.egfr }}{% endif %}
                                {% if report.metrics.serum_creatinine %} | Creatinine: {{
                                report.metrics.serum_creatinine }}{% endif %}
                            </div>
                        </div>
                        {% if report.pdf_path %}
                        <a href="{{ url_for('static', filename=report.pdf_path) }}" target="_blank" class="card-action"
                            style="font-size: 14px;">
                            <i class="fas fa-file-pdf"></i> View
                        </a>
                        {% else %}
                        <span style="font-size: 12px; color: var(--text-secondary);">No PDF</span>
                        {% endif %}
                    </div>
                    {% endfor %}

                    {# Hidden items for the rest #}
                    {% if history_list|length > 3 %}
                    <div id="more-history" style="display: none;">
                        {% for report in history_list[3:] %}
                        <div class="metric-item">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary);">{{ report.date }} - {{
                                    report.test_type if report.test_type else 'Lab Analysis' }}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    {% if report.metrics.egfr %}eGFR: {{ report.metrics.egfr }}{% endif %}
                                    {% if report.metrics.serum_creatinine %} | Creatinine: {{
                                    report.metrics.serum_creatinine }}{% endif %}
                                </div>
                            </div>
                            {% if report.pdf_path %}
                            <a href="{{ url_for('static', filename=report.pdf_path) }}" target="_blank"
                                class="card-action" style="font-size: 14px;">
                                <i class="fas fa-file-pdf"></i> View
                            </a>
                            {% else %}
                            <span style="font-size: 12px; color: var(--text-secondary);">No PDF</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                    <div style="text-align: center; margin-top: 10px;">
                        <button onclick="toggleHistory()" id="view-more-btn"
                            style="background: none; border: none; color: #0d9488; font-weight: 600; cursor: pointer;">
                            View More <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <script>
                        function toggleHistory() {
                            var moreHistory = document.getElementById("more-history");
                            var btn = document.getElementById("view-more-btn");
                            if (moreHistory.style.display === "none") {
                                moreHistory.style.display = "block";
                                btn.innerHTML = 'View Less <i class="fas fa-chevron-up"></i>';
                            } else {
                                moreHistory.style.display = "none";
                                btn.innerHTML = 'View More <i class="fas fa-chevron-down"></i>';
                            }
                        }
                    </script>
                    {% endif %}

                    {% else %}
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        No history available
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Right Column -->
            <div class="sidebar">
                <!-- Disease Status Overview -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-notes-medical"></i> Disease Analyis Status
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                        <!-- CKD Status -->
                        <div
                            style="background: {{ 'rgba(239, 68, 68, 0.1)' if disease_status.ckd and disease_status.ckd.prediction.risk_level == 'High' else ('rgba(245, 158, 11, 0.1)' if disease_status.ckd and disease_status.ckd.prediction.risk_level == 'Moderate' else ('rgba(16, 185, 129, 0.1)' if disease_status.ckd else '#f3f4f6')) }}; 
                                    border: 1px solid {{ '#ef4444' if disease_status.ckd and disease_status.ckd.prediction.risk_level == 'High' else ('#f59e0b' if disease_status.ckd and disease_status.ckd.prediction.risk_level == 'Moderate' else ('#10b981' if disease_status.ckd else '#e5e7eb')) }};
                                    border-radius: 8px; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center;">
                            <div
                                style="font-weight: 600; margin-bottom: 5px; color: var(--text-primary); font-size: 14px;">
                                CKD</div>
                            {% if disease_status.ckd %}
                            <div
                                style="font-size: 13px; font-weight: 700; color: {{ '#dc2626' if disease_status.ckd.prediction.risk_level == 'High' else ('#d97706' if disease_status.ckd.prediction.risk_level == 'Moderate' else '#059669') }}; margin-bottom: 4px;">
                                {{ disease_status.ckd.prediction.risk_level }} Risk
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                Stage: {{ disease_status.ckd.prediction.stage }}
                            </div>
                            {% else %}
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                Report not uploaded yet
                            </div>
                            {% endif %}
                        </div>

                        <!-- Kidney Stone Status -->
                        <div
                            style="background: {{ 'rgba(239, 68, 68, 0.1)' if disease_status.kidney_stone and disease_status.kidney_stone.prediction.risk_level == 'High' else ('rgba(245, 158, 11, 0.1)' if disease_status.kidney_stone and disease_status.kidney_stone.prediction.risk_level == 'Moderate' else ('rgba(16, 185, 129, 0.1)' if disease_status.kidney_stone else '#f3f4f6')) }}; 
                                    border: 1px solid {{ '#ef4444' if disease_status.kidney_stone and disease_status.kidney_stone.prediction.risk_level == 'High' else ('#f59e0b' if disease_status.kidney_stone and disease_status.kidney_stone.prediction.risk_level == 'Moderate' else ('#10b981' if disease_status.kidney_stone else '#e5e7eb')) }};
                                    border-radius: 8px; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center;">
                            <div
                                style="font-weight: 600; margin-bottom: 5px; color: var(--text-primary); font-size: 14px;">
                                Kidney Stone</div>
                            {% if disease_status.kidney_stone %}
                            <div
                                style="font-size: 13px; font-weight: 700; color: {{ '#dc2626' if disease_status.kidney_stone.prediction.risk_level == 'High' else ('#d97706' if disease_status.kidney_stone.prediction.risk_level == 'Moderate' else '#059669') }}; margin-bottom: 4px;">
                                {{ disease_status.kidney_stone.prediction.stage }}
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                {{ disease_status.kidney_stone.prediction.severity }}
                            </div>
                            {% else %}
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                Report not uploaded yet
                            </div>
                            {% endif %}
                        </div>

                        <!-- AKI Status -->
                        <div
                            style="background: {{ 'rgba(239, 68, 68, 0.1)' if disease_status.aki and disease_status.aki.prediction.risk_level == 'High' else ('rgba(245, 158, 11, 0.1)' if disease_status.aki and disease_status.aki.prediction.risk_level == 'Moderate' else ('rgba(16, 185, 129, 0.1)' if disease_status.aki else '#f3f4f6')) }}; 
                                    border: 1px solid {{ '#ef4444' if disease_status.aki and disease_status.aki.prediction.risk_level == 'High' else ('#f59e0b' if disease_status.aki and disease_status.aki.prediction.risk_level == 'Moderate' else ('#10b981' if disease_status.aki else '#e5e7eb')) }};
                                    border-radius: 8px; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center;">
                            <div
                                style="font-weight: 600; margin-bottom: 5px; color: var(--text-primary); font-size: 14px;">
                                AKI</div>
                            {% if disease_status.aki %}
                            <div
                                style="font-size: 13px; font-weight: 700; color: {{ '#dc2626' if disease_status.aki.prediction.risk_level == 'High' else ('#d97706' if disease_status.aki.prediction.risk_level == 'Moderate' else '#059669') }}; margin-bottom: 4px;">
                                {{ disease_status.aki.prediction.risk_level }} Risk
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                Stage: {{ disease_status.aki.prediction.stage }}
                            </div>
                            {% else %}
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                Report not uploaded yet
                            </div>
                            {% endif %}
                        </div>

                        <!-- ESRD Status -->
                        <div
                            style="background: {{ 'rgba(239, 68, 68, 0.1)' if disease_status.esrd and disease_status.esrd.prediction.risk_level == 'High' else ('rgba(245, 158, 11, 0.1)' if disease_status.esrd and disease_status.esrd.prediction.risk_level == 'Moderate' else ('rgba(16, 185, 129, 0.1)' if disease_status.esrd else '#f3f4f6')) }}; 
                                    border: 1px solid {{ '#ef4444' if disease_status.esrd and disease_status.esrd.prediction.risk_level == 'High' else ('#f59e0b' if disease_status.esrd and disease_status.esrd.prediction.risk_level == 'Moderate' else ('#10b981' if disease_status.esrd else '#e5e7eb')) }};
                                    border-radius: 8px; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center;">
                            <div
                                style="font-weight: 600; margin-bottom: 5px; color: var(--text-primary); font-size: 14px;">
                                ESRD</div>
                            {% if disease_status.esrd %}
                            <div
                                style="font-size: 13px; font-weight: 700; color: {{ '#dc2626' if disease_status.esrd.prediction.risk_level == 'High' else ('#d97706' if disease_status.esrd.prediction.risk_level == 'Moderate' else '#059669') }}; margin-bottom: 4px;">
                                {{ disease_status.esrd.prediction.risk_level }} Risk
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                Stage: {{ disease_status.esrd.prediction.stage }}
                            </div>
                            {% else %}
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                Report not uploaded yet
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- AI Lifestyle Recommendations -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-robot"></i> AI Lifestyle Recommendations
                        </div>
                        <a href="{{ url_for('ai_lifestyle_plan') }}" class="card-action">View Plan</a>
                    </div>

                    <div class="lifestyle-item">
                        <div class="lifestyle-icon">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="lifestyle-content">
                            <div class="lifestyle-title">Hydration</div>
                            <div class="lifestyle-description">Drink 8-10 glasses of water daily. Limit fluid intake if
                                advised by doctor.</div>
                        </div>
                    </div>

                    <div class="lifestyle-item">
                        <div class="lifestyle-icon">
                            <i class="fas fa-carrot"></i>
                        </div>
                        <div class="lifestyle-content">
                            <div class="lifestyle-title">Low Sodium Diet</div>
                            <div class="lifestyle-description">Limit sodium intake to less than 2,300mg per day. Avoid
                                processed foods.</div>
                        </div>
                    </div>

                    <div class="lifestyle-item">
                        <div class="lifestyle-icon">
                            <i class="fas fa-dumbbell"></i>
                        </div>
                        <div class="lifestyle-content">
                            <div class="lifestyle-title">Regular Exercise</div>
                            <div class="lifestyle-description">30 minutes of moderate exercise, 5 days a week. Walking,
                                swimming recommended.</div>
                        </div>
                    </div>
                </div>

                <!-- Available Doctors -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-user-md"></i> Available Doctors
                        </div>
                        <a href="{{ url_for('all_doctors_view') }}" class="card-action">View All</a>
                    </div>

                    {% for doctor in available_doctors %}
                    <div class="doctor-item" {% if doctor.priority==0
                        %}style="border-left: 4px solid #10b981; background: #f0fdfa;" {% endif %}>
                        <div class="doctor-avatar">{{ doctor.avatar }}</div>
                        <div class="doctor-info">
                            <div class="doctor-name">
                                {{ doctor.name }}
                                {% if doctor.priority == 0 %}
                                <span
                                    style="font-size: 10px; background: #10b981; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">Nearby</span>
                                {% endif %}
                            </div>
                            <div class="doctor-specialty">{{ doctor.specialty }} • <span style="color: #6b7280;">{{
                                    doctor.location }}</span></div>
                            <div class="doctor-experience">{{ doctor.experience }}</div>
                        </div>
                        <button class="book-btn" onclick="bookAppointment('{{ doctor.username }}')">Book</button>
                    </div>
                    {% endfor %}

                    <div
                        style="text-align: center; margin-top: 15px; padding-top: 10px; border-top: 1px solid #f3f4f6;">
                        <a href="{{ url_for('all_doctors_view') }}"
                            style="display: block; width: 100%; color: #0d9488; font-weight: 600; text-decoration: none; font-size: 14px;">
                            View All Doctors <i class="fas fa-arrow-right" style="margin-left: 5px;"></i>
                        </a>
                    </div>
                </div>

                <!-- Upcoming Checkup -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-video"></i> Upcoming Checkup
                        </div>
                    </div>

                    {% if upcoming_appointments and upcoming_appointments|length > 0 %}
                    {% for appointment in upcoming_appointments %}
                    <div class="upcoming-appointment-item">
                        <div class="appointment-doctor">
                            <div class="doctor-avatar">{{ appointment.doctor_details.avatar }}</div>
                            <div class="appointment-info">
                                <div class="doctor-name">Dr. {{ appointment.doctor_details.name }}</div>
                                <div class="doctor-specialty">{{ appointment.doctor_details.specialty }}</div>
                            </div>
                        </div>
                        <div class="appointment-details">
                            <div class="appointment-datetime">
                                <i class="fas fa-calendar"></i> {{ appointment.preferred_date }}
                                <i class="fas fa-clock" style="margin-left: 15px;"></i> {{ appointment.preferred_time }}
                            </div>
                            <a href="{{ appointment.meet_link }}" target="_blank" class="join-meeting-btn">
                                <i class="fas fa-video"></i> Join Video Call
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                        <i class="fas fa-calendar-xmark"
                            style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                        <div>No upcoming checkups scheduled</div>
                        <div style="font-size: 12px; margin-top: 5px;">Book an appointment with a doctor to get started
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>



    <script>
        function bookAppointment(doctorUsername) {
            const modalHtml = `
                                <div
                                    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
                                    <div
                                        style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                                        <h3 style="margin-top: 0; color: #333;">Book Appointment with Dr.
                                            ${doctorUsername}</h3>
                                        <div style="margin-bottom: 20px;">
                                            <label
                                                style="display: block; margin-bottom: 8px; font-weight: 500;">Preferred
                                                Date:</label>
                                            <input type="date" id="appointmentDate"
                                                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                                        </div>
                                        <div style="margin-bottom: 20px;">
                                            <label
                                                style="display: block; margin-bottom: 8px; font-weight: 500;">Preferred
                                                Time:</label>
                                            <input type="time" id="appointmentTime"
                                                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                                        </div>
                                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                                            <button onclick="closeModal()"
                                                style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 6px; background: #f5f5f5; cursor: pointer;">Cancel</button>
                                            <button onclick="submitAppointment('${doctorUsername}')"
                                                style="padding: 10px 20px; border: none; border-radius: 6px; background: #0d9488; color: white; cursor: pointer;">Book
                                                Appointment</button>
                                        </div>
                                    </div>
                                </div>
                                `;

            // Add modal to body
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHtml;
            document.body.appendChild(modalDiv);
        }

        function submitAppointment(doctorUsername) {
            const dateInput = document.getElementById('appointmentDate');
            const timeInput = document.getElementById('appointmentTime');

            const preferredDate = dateInput.value;
            const preferredTime = timeInput.value;

            if (!preferredDate || !preferredTime) {
                alert('Please select both date and time for your appointment.');
                return;
            }

            // Send booking request
            fetch('/patient/book-appointment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    doctor_name: doctorUsername,
                    preferred_date: preferredDate,
                    preferred_time: preferredTime
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const link = data.meet_link || 'Link not available';
                        alert(data.message + '\n\nVideo Call Link:\n' + link);
                        if (link && navigator.clipboard) navigator.clipboard.writeText(link);
                        closeModal();
                        window.location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to book appointment'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while booking the appointment.');
                });
        }

        function closeModal() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        }

        // Search functionality
        const searchInput = document.querySelector('.search-bar input');
        if (searchInput) {
            searchInput.addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase();
                // Here you would implement search functionality
                console.log('Searching for:', searchTerm);
            });
        }
    </script>

    <!-- Patient Education Chatbot -->
    <div id="chatbot-container" class="chatbot-container">
        <div class="chatbot-toggle" id="chatbot-trigger">
            <i class="fas fa-robot"></i>
        </div>
        <div id="chatbot-window" class="chatbot-window">
            <div class="chatbot-header">
                <h3>KidneyCompanion Assistant</h3>
                <button id="chatbot-close" class="chatbot-close">×</button>
            </div>
            <div id="chatbot-messages" class="chatbot-messages">
                <div class="chatbot-message bot">
                    <div class="chatbot-message-content">
                        Loading assistant...
                    </div>
                </div>
            </div>
            <div class="chatbot-input-container">
                <input type="text" id="chatbot-input" class="chatbot-input"
                    placeholder="Ask about CKD stages, symptoms, or medical terms...">
                <button id="chatbot-send" class="chatbot-send">Send</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Chatbot elements
            const chatbotContainer = document.getElementById('chatbot-container');
            const chatbotToggle = document.getElementById('chatbot-trigger');
            const chatbotWindow = document.getElementById('chatbot-window');
            const chatbotClose = document.getElementById('chatbot-close');
            const chatbotMessages = document.getElementById('chatbot-messages');
            const chatbotInput = document.getElementById('chatbot-input');
            const chatbotSend = document.getElementById('chatbot-send');

            // Toggle chatbot visibility
            if (chatbotToggle) {
                chatbotToggle.addEventListener('click', function () {
                    chatbotContainer.classList.toggle('active');
                });
            }

            // Close chatbot
            if (chatbotClose) {
                chatbotClose.addEventListener('click', function () {
                    chatbotContainer.classList.remove('active');
                });
            }

            // Send message on button click
            if (chatbotSend) {
                chatbotSend.addEventListener('click', sendMessage);
            }

            // Send message on Enter key
            if (chatbotInput) {
                chatbotInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // Function to send message
            function sendMessage() {
                const message = chatbotInput.value.trim();
                if (message) {
                    // Add user message to chat
                    addMessage(message, 'user');
                    chatbotInput.value = '';

                    // Send to backend
                    fetch('/chatbot/message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message }),
                        credentials: 'same-origin'
                    })
                        .then(response => {
                            console.log('Response status:', response.status);
                            console.log('Response headers:', [...response.headers.entries()]);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                addMessage(data.response, 'bot');
                            } else {
                                addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                            }
                        })
                        .catch(error => {
                            console.error('Error sending message:', error);
                            addMessage('Sorry, I encountered an error. Please try again. Check browser console for details.', 'bot');
                        });
                }
            }

            // Function to add message to chat
            function addMessage(content, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chatbot-message ${sender}`;
                messageDiv.innerHTML = `
                    <div class="chatbot-message-content">
                        ${content}
                    </div>
                `;
                chatbotMessages.appendChild(messageDiv);

                // Scroll to bottom
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }

            // Load welcome message
            fetch('/chatbot/welcome', {
                credentials: 'same-origin'
            })
                .then(response => {
                    console.log('Welcome response status:', response.status);
                    console.log('Welcome response headers:', [...response.headers.entries()]);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const welcomeMessage = chatbotMessages.querySelector('.chatbot-message.bot');
                        if (welcomeMessage) {
                            welcomeMessage.querySelector('.chatbot-message-content').textContent = data.message;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading welcome message:', error);
                    // Add error message to chat
                    const welcomeMessage = chatbotMessages.querySelector('.chatbot-message.bot');
                    if (welcomeMessage) {
                        welcomeMessage.querySelector('.chatbot-message-content').textContent = 'Failed to load assistant. Check browser console for details.';
                    }
                });
        });


    </script>

    <!-- Driver.js for Tour -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css" />
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>


    <!-- Tour using Driver.js -->
    <script>
        // Tour Logic
        document.addEventListener('DOMContentLoaded', function () {
            // Check if we should show the tour
            const showTour = {{ 'true' if show_tour else 'false' }};

        console.log('Tour check - showTour:', showTour);

        if (showTour) {
            console.log('Initializing tour...');

            // Wait for driver.js to load
            setTimeout(() => {
                if (!window.driver || !window.driver.js) {
                    console.error('Driver.js not loaded!');
                    return;
                }

                // Initialize driver
                const driver = window.driver.js.driver;
                const avatarUrl = "{{ url_for('static', filename='images/ai_avatar.png') }}";

                const driverObj = driver({
                    showProgress: true,
                    animate: true,
                    allowClose: true,
                    overlayColor: 'rgba(0, 0, 0, 0.6)',
                    popoverClass: 'tour-popover',
                    onDestroyStarted: () => {
                        // Mark tour as complete when finished or closed
                        fetch('/api/complete-tour', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        }).then(() => console.log('Tour marked complete'));
                        driverObj.destroy();
                    },
                    steps: [
                        {
                            element: '.welcome-message',
                            popover: {
                                title: 'Welcome!',
                                description: "Hi! I'm your Personal Health Assistant. I'll quickly show you around your dashboard.",
                                side: "bottom",
                                align: 'start'
                            }
                        },
                        {
                            element: '#stats-overview',
                            popover: {
                                title: 'Health Overview',
                                description: 'See your key metrics like CKD Stage and Risk Level at a glance right here.',
                                side: "bottom",
                                align: 'start'
                            }
                        },
                        {
                            element: '#upload-section',
                            popover: {
                                title: 'Analysis Tool',
                                description: "Upload your lab reports here. I'll analyze them to track your progress automatically.",
                                side: "top",
                                align: 'start'
                            }
                        },
                        {
                            element: '#chatbot-trigger',
                            popover: {
                                title: 'Chat with Me',
                                description: "I'm always here! Click this button to ask me anything about your health.",
                                side: "left",
                                align: 'start'
                            }
                        }
                    ]
                });

                // Custom styling for the popover
                const style = document.createElement('style');
                style.innerHTML = `
                        .tour-popover {
                            max-width: 400px !important;
                            border-radius: 16px !important;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
                        }
                        .driver-popover-title {
                            font-size: 18px !important;
                            font-weight: 700 !important;
                            color: #0d9488 !important;
                            margin-bottom: 8px !important;
                        }
                        .driver-popover-description {
                            font-size: 14px !important;
                            color: #4b5563 !important;
                            line-height: 1.5 !important;
                        }
                    `;
                document.head.appendChild(style);

                // Start tour after a short delay
                setTimeout(() => {
                    console.log('Starting tour...');
                    driverObj.drive();
                }, 1000);
            }, 500);
        } else {
            console.log('Tour already seen or not applicable');
        }
        });
    </script>
</body>

</html>